---
title: "Analyse : statistiques descriptives"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyse : statistiques descriptives}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library(qesR)
library(dplyr)
library(ggplot2)
library(knitr)
```

## Chargement des données fusionnées

```{r}
master <- if (file.exists("qes_master.csv")) {
  read.csv("qes_master.csv", stringsAsFactors = FALSE)
} else {
  get_qes_master(assign_global = FALSE, strict = FALSE, quiet = TRUE)
}

parser_turnout <- function(x) {
  brut <- trimws(as.character(x))
  norm <- tolower(iconv(brut, from = "", to = "ASCII//TRANSLIT"))
  out <- rep(NA_real_, length(norm))

  as_num <- suppressWarnings(as.numeric(brut))
  is_num <- is.finite(as_num)
  if (any(is_num)) {
    uniq <- unique(as_num[is_num])
    if (all(uniq %in% c(0, 1))) {
      out[is_num] <- as_num[is_num]
    }
  }

  non_hit <- grepl("^(0|2|non|no)$|n[' ]?a pas vot|did not vot|didn[' ]?t vot|annule|ne votera pas", norm, perl = TRUE)
  oui_hit <- grepl("^(1|oui|yes)$|\\boui\\b|\\byes\\b|already voted|par anticipation|le jour meme|certain to vote", norm, perl = TRUE)

  out[non_hit] <- 0
  out[oui_hit & !non_hit] <- 1
  out
}

master <- master %>%
  mutate(
    annee = suppressWarnings(as.integer(sub("^([0-9]{4}).*$", "\\1", qes_year))),
    age_group = trimws(as.character(age_group)),
    turnout_num = parser_turnout(turnout)
  )

# qes_crop_2007_2010 est un fichier regroupé sans variable d'année par ligne.
# On le garde dans les tableaux par étude, mais pas dans les tendances annuelles.
master_tendance <- master %>%
  filter(qes_code != "qes_crop_2007_2010")
```

## Taille des échantillons

```{r}
tailles <- master %>%
  group_by(qes_year, qes_code, qes_name_en) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(qes_year, qes_code)

knitr::kable(tailles, caption = "Taille d'échantillon par étude")
```

## Répartition des groupes d'âge

```{r}
age_dist <- master_tendance %>%
  filter(!is.na(annee), !is.na(age_group), nzchar(age_group)) %>%
  group_by(annee, age_group) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  mutate(pct = 100 * n / sum(n)) %>%
  ungroup()

knitr::kable(
  head(age_dist, 28),
  digits = 1,
  caption = "Répartition des groupes d'âge (premières lignes)"
)
```

```{r, fig.alt="Carte thermique de la répartition des groupes d'âge selon l'année."}
ordre_age <- c("<18", "18-24", "25-34", "35-44", "45-54", "55-64", "65+")
age_dist$age_group <- factor(age_dist$age_group, levels = ordre_age)

ggplot(age_dist, aes(x = annee, y = age_group, fill = pct)) +
  geom_tile(color = "#ffffff", linewidth = 0.35) +
  scale_fill_gradient(low = "#dfe8f2", high = "#12355b", name = "%") +
  labs(
    title = "Répartition des groupes d'âge dans le temps",
    x = "Année d'étude",
    y = "Groupe d'âge"
  ) +
  theme_minimal(base_size = 12)
```

## Participation électorale par année

```{r}
annees <- data.frame(annee = sort(unique(master_tendance$annee[!is.na(master_tendance$annee)])))

turnout_annee <- master_tendance %>%
  filter(!is.na(annee)) %>%
  group_by(annee) %>%
  summarise(
    repondants = n(),
    n_avec_turnout = sum(!is.na(turnout_num)),
    taux = ifelse(n_avec_turnout > 0, mean(turnout_num, na.rm = TRUE), NA_real_),
    se = ifelse(
      n_avec_turnout > 0,
      sqrt(pmax(taux * (1 - taux), 0) / n_avec_turnout),
      NA_real_
    ),
    ci_bas = ifelse(!is.na(se), pmax(0, taux - 1.96 * se), NA_real_),
    ci_haut = ifelse(!is.na(se), pmin(1, taux + 1.96 * se), NA_real_),
    .groups = "drop"
  )

turnout_annee <- merge(annees, turnout_annee, by = "annee", all.x = TRUE, sort = TRUE)

knitr::kable(
  turnout_annee %>%
    mutate(
      taux_pct = round(100 * taux, 1),
      ci_bas_pct = round(100 * ci_bas, 1),
      ci_haut_pct = round(100 * ci_haut, 1)
    ),
  col.names = c("Année", "Répondants", "N avec mesure", "Taux", "SE", "IC bas", "IC haut", "Taux (%)", "IC bas (%)", "IC haut (%)"),
  caption = "Indicateur de participation par année"
)
```

```{r, fig.alt="Graphique de l'indicateur de participation électorale selon l'année."}
plot_turnout <- turnout_annee %>%
  filter(!is.na(taux), !is.na(ci_bas), !is.na(ci_haut))

ggplot(plot_turnout, aes(x = annee, y = taux)) +
  geom_ribbon(aes(ymin = ci_bas, ymax = ci_haut), fill = "#9fb6ce", alpha = 0.35, na.rm = TRUE) +
  geom_line(linewidth = 1, color = "#12355b", na.rm = TRUE) +
  geom_point(size = 2.3, color = "#b5651d", na.rm = TRUE) +
  geom_smooth(
    method = "loess",
    se = TRUE,
    span = 0.9,
    color = "#12355b",
    fill = "#c9d6e4",
    alpha = 0.25,
    linetype = "dashed",
    linewidth = 0.8,
    na.rm = TRUE
  ) +
  scale_y_continuous(labels = function(x) paste0(round(100 * x, 0), "%")) +
  labs(
    title = "Indicateur de participation électorale",
    x = "Année d'étude",
    y = "Part des répondants"
  ) +
  theme_minimal(base_size = 12)
```

## Notes

- `qes_crop_2007_2010` est exclu des tableaux et graphiques par année parce que
  ce fichier ne contient pas d'année au niveau des répondants.
