---
title: "Merged Dataset Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Merged Dataset Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", eval = FALSE)
```

`qesR` provides a merged harmonized dataset through `get_qes_master()`.

## Build merged data

```{r}
library(qesR)

master <- get_qes_master(strict = FALSE)
dim(master)
head(master)
```

## What it harmonizes

Current harmonized columns in `qes_master`:

`qes_code`, `qes_year`, `qes_name_en`, `respondent_id`, `interview_start`, `interview_end`, `interview_recorded`, `language`, `citizenship`, `year_of_birth`, `age`, `age_group`, `gender`, `province_territory`, `education`, `income`, `religion`, `born_canada`, `political_interest`, `ideology`, `turnout`, `vote_choice`, `vote_choice_text`, `party_best`, `party_lean`, `sovereignty_support`, `sovereignty`, `federal_pid`, `provincial_pid`, `survey_weight`, `definibin`, `ethn1`, `influperso`, `luentend`, `occup`, `patron`, `pondam1`, `laide_familles_etait_enjeu_important_election_q10`, `principale_source_dinformation_politique_ne_pas_lire_q16`, `deuxieme_source_dinformation_politique_television_radio_journaux_q17`, `which_party_best_managing_health_care_system_q18`, `gens_ont_differentes_facons_se_definir_diriez_considerez_q18a`, `gens_ont_differentes_facons_se_definir_diriez_considerez_q18b`, `eme_si_navez_peut_pas_encore_fait_choix_q20`, `which_party_best_fighting_corruption_q20b`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q22`, `mesure_faites_confiance_gouvernements_faire_doit_fait_leur_q23`, `pensez_gens_gouvernement_gaspillent_beaucoup_quelque_peu_ou_q24`, `leducation_etait_enjeu_important_election_q3`, `echelle_zero_cent_zero_veut_dire_naimez_vraiment_q31`, `personnellement_trouvez_lidee_tenir_election_quebec_automne_etai_q33`, `recemment_gouvernement_quebec_commence_envisager_possibilite_mod_q35`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q37`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q38`, `maintenant_nous_parlons_chefs_partis_utilisant_echelle_zero_q39`, `according_what_main_difference_between_quebecois_people_peopl_q4`, `maintenant_nous_parlons_chefs_partis_utilisant_echelle_zero_q40`, `maintenant_nous_parlons_chefs_partis_utilisant_echelle_zero_q41`, `maintenant_nous_parlons_chefs_partis_utilisant_echelle_zero_q42`, `maintenant_nous_parlons_chefs_partis_utilisant_echelle_zero_q43`, `selon_lequel_chefs_parti_plus_competent_ne_pas_q44`, `would_say_canadian_government_intervenes_too_much_affairs_q45`, `selon_lequel_chefs_parti_plus_proche_gens_ne_q46`, `selon_leconomie_quebecoise_sest_elle_amelioree_deterioree_ou_q47`, `considerez_surtout_comme_federaliste_surtout_comme_souverainiste_q48`, `dapres_lavenir_q49`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q50`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q51`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q53`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q54`, `selon_parti_politique_meilleur_ameliorer_soins_sante_ne_q55`, `if_had_choose_between_no_change_more_powers_q56`, `parti_meilleur_proteger_lenvironnement_ne_pas_lire_liste_q58`, `parti_meilleur_lutter_contre_pauvrete_ne_pas_lire_q59`, `it_important_quebec_has_sufficient_voice_central_decision_q60`, `parti_meilleur_defendre_lidentite_culture_quebecoise_ne_pas_q61b`, `parti_meilleur_soccuper_caisse_dep_ot_placement_quebec_q61d`, `each_following_areas_think_decisions_should_made_by_q62a`, `each_following_areas_think_decisions_should_made_by_q62b`, `echelle_va_100_ou_veut_dire_naimez_vraiment_q64`, `echelle_va_100_ou_veut_dire_naimez_vraiment_q65`, `etes_ou_contre_mariage_entre_personnes_eme_sexe_q66`, `veuillez_indiquer_si_etes_fortement_daccord_plut_ot_q68`, `baisses_dimp_ots_etaient_enjeu_important_election_q7`, `politique_provinciale_habituellement_identifiez_q70`, `sentez_peu_plus_proche_lun_ou_lautre_partis_q72`, `parti_q73`, `lors_derniere_election_federale_janvier_2006_parti_avez_q74`, `travaillez_actuellement_compte_etes_salarie_avez_pris_retraite_q79`, `statut_politique_quebec_etait_enjeu_important_election_q8`, `langue_parlez_plus_souvent_maison_q80`, `some_people_say_governments_should_see_it_every_q81`, `pauvrete_etait_enjeu_important_election_q9`, `raison_vote_recodee_raison1`, `raison_vote_recodee_raison2`, `jour_semaine_s_jse`, `diriez_etes_tres_satisfait_plut_ot_satisfait_plut_satisf`, `var_27_personnellement_jusqua_point_fiez_sondages_savoir_gagnera_sefie`, `var_28a_diriez_sondages_pendant_campagnes_electorales_tres_bonne_sondbons`, `var_15a_parti_avez_vote_dernieres_elections_provinciales_davril_voteprec`

`get_qes_master()` also keeps the merge logic explicit:

- uses cross-study variable maps and value normalization for comparability
- derives `age_group` where age or year-of-birth is available
- retains panel and non-panel respondents as separate observations
- renames opaque legacy variables (for example `q10`, `q16`, `voteprec`) to readable merged names
- stores source-variable provenance in `attr(master, "source_map")`
- stores the list of added cross-study variables in `attr(master, "crossstudy_variables_added")`
- stores old-to-new variable renaming in `attr(master, "variable_name_map")`

It also records source-variable provenance:

```{r}
source_map <- attr(master, "source_map")
head(source_map)
```

```{r}
name_map <- attr(master, "variable_name_map")
head(name_map)
```

## Quality controls in merge

`get_qes_master()` applies:

- respondent de-duplication within the same survey code
- derived age groups where age or year-of-birth are available
- removal of rows empty across harmonized variables

## Save merged data

```{r}
get_qes_master(save_path = "qes_master.csv", strict = FALSE)
get_qes_master(save_path = "qes_master.rds", strict = FALSE)
```
