---
title: "Use case: Descriptive Statistics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use case: Descriptive Statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library(qesR)
library(dplyr)
library(ggplot2)
library(knitr)
```

```{r}
master <- if (file.exists("qes_master.csv")) {
  read.csv("qes_master.csv", stringsAsFactors = FALSE)
} else {
  get_qes_master(assign_global = FALSE, strict = FALSE, quiet = TRUE)
}

parse_turnout <- function(x) {
  raw <- trimws(as.character(x))
  norm <- tolower(iconv(raw, from = "", to = "ASCII//TRANSLIT"))
  out <- rep(NA_real_, length(norm))

  as_num <- suppressWarnings(as.numeric(raw))
  is_num <- is.finite(as_num)
  if (any(is_num)) {
    uniq <- unique(as_num[is_num])
    if (all(uniq %in% c(0, 1))) {
      out[is_num] <- as_num[is_num]
    }
  }

  no_hit <- grepl("^(0|2|non|no)$|n[' ]?a pas vot|did not vot|didn[' ]?t vot|annule|ne votera pas", norm, perl = TRUE)
  yes_hit <- grepl("^(1|oui|yes)$|\\boui\\b|\\byes\\b|already voted|par anticipation|le jour meme|certain to vote", norm, perl = TRUE)

  out[no_hit] <- 0
  out[yes_hit & !no_hit] <- 1
  out
}

collapse_age_group3 <- function(x) {
  raw <- trimws(as.character(x))
  raw[!nzchar(raw)] <- NA_character_
  norm <- tolower(iconv(raw, from = "", to = "ASCII//TRANSLIT"))
  out <- rep(NA_character_, length(norm))

  out[grepl("18\\s*[-toa ]\\s*24|25\\s*[-toa ]\\s*34|18\\s*[-toa ]\\s*34|de\\s*18\\s*a\\s*24|de\\s*25\\s*a\\s*34", norm, perl = TRUE)] <- "18-34"
  out[grepl("35\\s*[-toa ]\\s*44|45\\s*[-toa ]\\s*54|35\\s*[-toa ]\\s*54|de\\s*35\\s*a\\s*44|de\\s*45\\s*a\\s*54", norm, perl = TRUE)] <- "35-54"
  out[grepl("55\\s*[-toa ]\\s*64|65\\+|65\\s*ans\\s*et\\s*plus|55\\+|55\\s*ans\\s*et\\s*plus", norm, perl = TRUE)] <- "55+"

  out
}

master <- master %>%
  mutate(
    qes_year_num = suppressWarnings(as.integer(sub("^([0-9]{4}).*$", "\\1", qes_year))),
    age_group = trimws(as.character(age_group)),
    turnout_num = parse_turnout(turnout)
  )

# qes_crop_2007_2010 is a pooled file without row-level year information.
# Keep it in study-level tables, but exclude it from year-trend summaries.
master_trend <- master %>%
  filter(qes_code != "qes_crop_2007_2010")
```

## Table 1: sample sizes by study

```{r}
sample_sizes <- master %>%
  group_by(qes_year, qes_code, qes_name_en) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(qes_year, qes_code)

knitr::kable(
  sample_sizes %>%
    transmute(
      `Study year` = qes_year,
      `Study code` = qes_code,
      `Sample size` = n
    ),
  caption = "Sample sizes by study"
)
```

## Table 2: age-group composition by year (share %)

```{r}
age_order <- c("18-34", "35-54", "55+")

age_table <- master_trend %>%
  mutate(age_group_3 = collapse_age_group3(age_group)) %>%
  filter(!is.na(qes_year_num), !is.na(age_group_3), nzchar(age_group_3)) %>%
  group_by(qes_year_num, age_group_3) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  mutate(pct = 100 * n / sum(n)) %>%
  ungroup() %>%
  arrange(qes_year_num, age_group_3)

age_table$age_group_3 <- factor(age_table$age_group_3, levels = age_order)

age_summary <- age_table %>%
  group_by(qes_year_num) %>%
  summarise(
    n_with_age_group = sum(n),
    pct_18_34 = ifelse(
      n_with_age_group > 0,
      100 * sum(n[age_group_3 == "18-34"], na.rm = TRUE) / n_with_age_group,
      NA_real_
    ),
    pct_35_54 = ifelse(
      n_with_age_group > 0,
      100 * sum(n[age_group_3 == "35-54"], na.rm = TRUE) / n_with_age_group,
      NA_real_
    ),
    pct_55_plus = ifelse(
      n_with_age_group > 0,
      100 * sum(n[age_group_3 == "55+"], na.rm = TRUE) / n_with_age_group,
      NA_real_
    ),
    .groups = "drop"
  ) %>%
  arrange(qes_year_num)

knitr::kable(
  age_summary %>%
    transmute(
      `Study year` = qes_year_num,
      `N with age group` = n_with_age_group,
      `18-34 (%)` = round(pct_18_34, 1),
      `35-54 (%)` = round(pct_35_54, 1),
      `55+ (%)` = round(pct_55_plus, 1)
    ),
  digits = 1,
  caption = "Age-group composition by year"
)
```

## Figure 1: age-group profile over time

```{r, fig.alt="Line chart of harmonized age-group composition across study years."}
age_table$age_group_3 <- factor(age_table$age_group_3, levels = age_order)

ggplot(age_table, aes(x = qes_year_num, y = pct, color = age_group_3, group = age_group_3)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2.2) +
  geom_smooth(
    method = "loess",
    se = FALSE,
    span = 0.9,
    linewidth = 0.8,
    linetype = "dashed"
  ) +
  scale_color_manual(
    values = c(
      "18-34" = "#2c7fb8",
      "35-54" = "#12355b",
      "55+" = "#b5651d"
    ),
    name = "Age group"
  ) +
  scale_y_continuous(labels = function(x) paste0(round(x, 0), "%"), limits = c(0, 100)) +
  labs(
    title = "Age-group composition across years",
    x = "Study year",
    y = "Share of respondents"
  ) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank())
```

## Table 3 and Figure 2: turnout by year

```{r}
all_years <- data.frame(qes_year_num = sort(unique(master_trend$qes_year_num[!is.na(master_trend$qes_year_num)])))

turnout_year <- master_trend %>%
  filter(!is.na(qes_year_num)) %>%
  group_by(qes_year_num) %>%
  summarise(
    respondents = n(),
    n_with_turnout = sum(!is.na(turnout_num)),
    turnout_rate = ifelse(n_with_turnout > 0, mean(turnout_num, na.rm = TRUE), NA_real_),
    se = ifelse(
      n_with_turnout > 0,
      sqrt(pmax(turnout_rate * (1 - turnout_rate), 0) / n_with_turnout),
      NA_real_
    ),
    ci_low = ifelse(!is.na(se), pmax(0, turnout_rate - 1.96 * se), NA_real_),
    ci_high = ifelse(!is.na(se), pmin(1, turnout_rate + 1.96 * se), NA_real_),
    .groups = "drop"
  )

turnout_year <- merge(all_years, turnout_year, by = "qes_year_num", all.x = TRUE, sort = TRUE)

knitr::kable(
  turnout_year %>%
    mutate(
      turnout_pct = round(100 * turnout_rate, 1),
      ci_low_pct = round(100 * ci_low, 1),
      ci_high_pct = round(100 * ci_high, 1)
    ) %>%
    transmute(
      `Study year` = qes_year_num,
      `N respondents` = respondents,
      `N with turnout item` = n_with_turnout,
      `Turnout rate (%)` = turnout_pct,
      `95% CI (%)` = ifelse(is.na(ci_low_pct), NA_character_, sprintf("%.1f to %.1f", ci_low_pct, ci_high_pct))
    ),
  caption = "Turnout indicator by year"
)
```

```{r, fig.alt="Line chart of turnout indicator across study years."}
plot_turnout <- turnout_year %>%
  filter(!is.na(turnout_rate), !is.na(ci_low), !is.na(ci_high))

ggplot(plot_turnout, aes(x = qes_year_num, y = turnout_rate)) +
  geom_ribbon(aes(ymin = ci_low, ymax = ci_high), fill = "#9fb6ce", alpha = 0.35, na.rm = TRUE) +
  geom_line(linewidth = 1, color = "#12355b", na.rm = TRUE) +
  geom_point(size = 2.3, color = "#b5651d", na.rm = TRUE) +
  geom_smooth(
    method = "loess",
    se = TRUE,
    span = 0.9,
    color = "#12355b",
    fill = "#c9d6e4",
    alpha = 0.25,
    linetype = "dashed",
    linewidth = 0.8,
    na.rm = TRUE
  ) +
  scale_y_continuous(labels = function(x) paste0(round(100 * x, 0), "%")) +
  labs(
    title = "Turnout indicator across study years",
    x = "Study year",
    y = "Share of respondents"
  ) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank())
```

## Notes

- `qes_crop_2007_2010` is excluded from year-trend tables/plots because it does
  not contain a row-level year field.
