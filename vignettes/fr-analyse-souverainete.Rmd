---
title: "Analyse : évolution des attitudes liées à la souveraineté"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyse : évolution des attitudes liées à la souveraineté}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library(qesR)
library(dplyr)
library(ggplot2)
library(knitr)
```

Cette page présente l'évolution de l'appui à la souveraineté dans le fichier fusionné.

## Chargement

```{r}
master <- if (file.exists("qes_master.csv")) {
  read.csv("qes_master.csv", stringsAsFactors = FALSE)
} else {
  get_qes_master(assign_global = FALSE, strict = FALSE, quiet = TRUE)
}

master <- master %>%
  mutate(
    annee = suppressWarnings(as.integer(sub("^([0-9]{4}).*$", "\\1", qes_year)))
  )

# Les vagues CROP sont exclues ici pour conserver une série basée sur les
# enquêtes électorales.
master <- master %>%
  filter(qes_code != "qes_crop_2007_2010")

if (!("sovereignty_support" %in% names(master))) {
  master$sovereignty_support <- NA_real_
}
```

## Question directe sur la souveraineté

```{r}
master <- master %>%
  mutate(
    appui_souverainete = suppressWarnings(as.numeric(sovereignty_support))
  )

master$appui_souverainete[!(master$appui_souverainete %in% c(0, 1))] <- NA_real_

annees <- data.frame(
  annee = sort(unique(master$annee[!is.na(master$annee)]))
)

sov <- master %>%
  filter(!is.na(annee)) %>%
  group_by(annee) %>%
  summarise(
    repondants = n(),
    n_mesure = sum(!is.na(appui_souverainete)),
    taux = ifelse(n_mesure > 0, mean(appui_souverainete, na.rm = TRUE), NA_real_),
    se = ifelse(
      n_mesure > 0,
      sqrt(pmax(taux * (1 - taux), 0) / n_mesure),
      NA_real_
    ),
    ci_bas = ifelse(!is.na(se), pmax(0, taux - 1.96 * se), NA_real_),
    ci_haut = ifelse(!is.na(se), pmin(1, taux + 1.96 * se), NA_real_),
    .groups = "drop"
  )

sov <- merge(annees, sov, by = "annee", all.x = TRUE, sort = TRUE)
```

```{r}
knitr::kable(
  sov %>%
    mutate(
      appui_souverainete_pct = round(100 * taux, 1),
      ci_bas_pct = round(100 * ci_bas, 1),
      ci_haut_pct = round(100 * ci_haut, 1)
    ) %>%
    transmute(
      `Annee d'etude` = annee,
      `N repondants` = repondants,
      `N avec item souverainete` = n_mesure,
      `Appui a la souverainete (%)` = appui_souverainete_pct,
      `IC 95% (%)` = ifelse(is.na(ci_bas_pct), NA_character_, sprintf("%.1f a %.1f", ci_bas_pct, ci_haut_pct))
    ),
  caption = "Appui à la souveraineté par année"
)
```

```{r, fig.alt="Graphique de l'évolution de l'appui à la souveraineté par année."}
plot_sov <- sov %>%
  filter(!is.na(taux), !is.na(ci_bas), !is.na(ci_haut))

ggplot(plot_sov, aes(x = annee, y = taux)) +
  geom_ribbon(aes(ymin = ci_bas, ymax = ci_haut), fill = "#9fb6ce", alpha = 0.35, na.rm = TRUE) +
  geom_line(linewidth = 1, color = "#12355b", na.rm = TRUE) +
  geom_point(size = 2.3, color = "#b5651d", na.rm = TRUE) +
  geom_smooth(
    method = "loess",
    se = TRUE,
    span = 0.9,
    color = "#12355b",
    fill = "#c9d6e4",
    alpha = 0.25,
    linetype = "dashed",
    linewidth = 0.8,
    na.rm = TRUE
  ) +
  scale_y_continuous(labels = function(x) paste0(round(100 * x, 0), "%")) +
  labs(
    title = "Évolution de l'appui à la souveraineté",
    x = "Année d'étude",
    y = "Part des répondants"
  ) +
  theme_minimal(base_size = 12)
```

## Notes

- L'analyse repose uniquement sur la variable directe d'appui à la souveraineté.
- Les intervalles de confiance sont des IC95 binomiaux (approximation normale).
- La colonne `N avec mesure` indique la couverture disponible selon l'année.
