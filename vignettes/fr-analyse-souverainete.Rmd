---
title: "Exemple de cas d'usage : évolution des attitudes liées à la souveraineté"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exemple de cas d'usage : évolution des attitudes liées à la souveraineté}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library(qesR)
library(dplyr)
library(ggplot2)
library(knitr)
```

Cette page utilise le fichier fusionné pour estimer l'appui à la souveraineté dans le temps.

<details>
<summary>Afficher le code utilisé dans cette page</summary>

```r
library(dplyr)
library(ggplot2)
library(knitr)

pkg_master <- system.file("extdata", "qes_master.csv", package = "qesR")
master_paths <- c("qes_master.csv", "../qes_master.csv", pkg_master)
master_paths <- master_paths[nzchar(master_paths)]
master <- read.csv(master_paths[file.exists(master_paths)][1], stringsAsFactors = FALSE)

master <- master %>%
  mutate(
    qes_year_chr = trimws(as.character(qes_year)),
    qes_year_num = as.integer(substr(qes_year_chr, 1, 4))
  )

is_range <- grepl("^[0-9]{4}-[0-9]{4}$", master$qes_year_chr)
start_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\1", master$qes_year_chr)))
end_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\2", master$qes_year_chr)))

master$periode_etude <- ifelse(
  is_range,
  master$qes_year_chr,
  ifelse(!is.na(master$qes_year_num), as.character(master$qes_year_num), master$qes_year_chr)
)
master$ordre_periode <- ifelse(
  is_range & is.finite(start_year) & is.finite(end_year),
  (start_year + end_year) / 2,
  master$qes_year_num
)

master$sovereignty_support <- suppressWarnings(as.numeric(master$sovereignty_support))
master$sovereignty_support[!(master$sovereignty_support %in% c(0, 1))] <- NA_real_

toutes_periodes <- master %>%
  filter(!is.na(periode_etude), nzchar(periode_etude), !is.na(ordre_periode)) %>%
  distinct(periode_etude, ordre_periode)

sov <- master %>%
  filter(!is.na(periode_etude), nzchar(periode_etude), !is.na(ordre_periode)) %>%
  group_by(periode_etude, ordre_periode) %>%
  summarise(
    repondants = n(),
    n_avec_mesure = sum(!is.na(sovereignty_support)),
    part_appui = ifelse(n_avec_mesure > 0, mean(sovereignty_support, na.rm = TRUE), NA_real_),
    se = ifelse(n_avec_mesure > 0, sqrt(pmax(part_appui * (1 - part_appui), 0) / n_avec_mesure), NA_real_),
    ic_bas = ifelse(!is.na(se), pmax(0, part_appui - 1.96 * se), NA_real_),
    ic_haut = ifelse(!is.na(se), pmin(1, part_appui + 1.96 * se), NA_real_),
    .groups = "drop"
  )

sov <- merge(toutes_periodes, sov, by = c("periode_etude", "ordre_periode"), all.x = TRUE, sort = TRUE)
sov <- sov %>% arrange(ordre_periode, periode_etude)
sov$indice_periode <- seq_len(nrow(sov))

knitr::kable(sov)
```

</details>

```{r, include = FALSE}
pkg_master <- system.file("extdata", "qes_master.csv", package = "qesR")
master_paths <- c("qes_master.csv", "../qes_master.csv", pkg_master)
master_paths <- master_paths[nzchar(master_paths)]
master_path <- master_paths[file.exists(master_paths)][1]
if (is.na(master_path) || !nzchar(master_path)) {
  stop("qes_master.csv introuvable localement. Lancez d'abord scripts/build_qes_master.R", call. = FALSE)
}
master <- read.csv(master_path, stringsAsFactors = FALSE)

master <- master %>%
  mutate(
    qes_year_chr = trimws(as.character(qes_year)),
    qes_year_num = suppressWarnings(as.integer(substr(qes_year_chr, 1, 4)))
  )

is_range <- grepl("^[0-9]{4}-[0-9]{4}$", master$qes_year_chr)
start_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\1", master$qes_year_chr)))
end_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\2", master$qes_year_chr)))

master$periode_etude <- ifelse(
  is_range,
  master$qes_year_chr,
  ifelse(!is.na(master$qes_year_num), as.character(master$qes_year_num), master$qes_year_chr)
)
master$ordre_periode <- ifelse(
  is_range & is.finite(start_year) & is.finite(end_year),
  (start_year + end_year) / 2,
  master$qes_year_num
)

if (!("sovereignty_support" %in% names(master))) {
  master$sovereignty_support <- NA_real_
}
master <- master %>%
  mutate(appui_souverainete = suppressWarnings(as.numeric(sovereignty_support)))

master$appui_souverainete[!(master$appui_souverainete %in% c(0, 1))] <- NA_real_

toutes_periodes <- master %>%
  filter(!is.na(periode_etude), nzchar(periode_etude), !is.na(ordre_periode)) %>%
  distinct(periode_etude, ordre_periode)

sov <- master %>%
  filter(!is.na(periode_etude), nzchar(periode_etude), !is.na(ordre_periode)) %>%
  group_by(periode_etude, ordre_periode) %>%
  summarise(
    repondants = n(),
    n_avec_mesure = sum(!is.na(appui_souverainete)),
    part_appui = ifelse(n_avec_mesure > 0, mean(appui_souverainete, na.rm = TRUE), NA_real_),
    se = ifelse(
      n_avec_mesure > 0,
      sqrt(pmax(part_appui * (1 - part_appui), 0) / n_avec_mesure),
      NA_real_
    ),
    ic_bas = ifelse(!is.na(se), pmax(0, part_appui - 1.96 * se), NA_real_),
    ic_haut = ifelse(!is.na(se), pmin(1, part_appui + 1.96 * se), NA_real_),
    .groups = "drop"
  )

sov <- merge(toutes_periodes, sov, by = c("periode_etude", "ordre_periode"), all.x = TRUE, sort = TRUE)
sov <- sov %>% arrange(ordre_periode, periode_etude)
periodes <- sov$periode_etude
sov$indice_periode <- seq_len(nrow(sov))
```

Les estimations ci-dessous utilisent la question directe sur la souveraineté harmonisée entre les périodes.

## Tableau 1 : appui à la souveraineté par période d'étude

```{r}
knitr::kable(
  sov %>%
    mutate(
      appui_pct = round(100 * part_appui, 1),
      ic_bas_pct = round(100 * ic_bas, 1),
      ic_haut_pct = round(100 * ic_haut, 1)
    ) %>%
    transmute(
      `Période d'étude` = periode_etude,
      `N répondants` = repondants,
      `N avec item souveraineté` = n_avec_mesure,
      `Appui à la souveraineté (%)` = appui_pct,
      `IC 95 % (%)` = ifelse(is.na(ic_bas_pct), NA_character_, sprintf("%.1f à %.1f", ic_bas_pct, ic_haut_pct))
    ),
  caption = "Appui à la souveraineté par période d'étude"
)
```

## Figure 1 : tendance de l'appui à la souveraineté

```{r, fig.alt="Graphique de l'évolution de l'appui à la souveraineté par période d'étude."}
plot_sov <- sov %>%
  filter(!is.na(part_appui), !is.na(ic_bas), !is.na(ic_haut), !is.na(indice_periode))
ymax_sov <- suppressWarnings(max(plot_sov$ic_haut, plot_sov$part_appui, na.rm = TRUE))
ymax_sov <- if (is.finite(ymax_sov)) min(1, ymax_sov + 0.05) else 1

ggplot(plot_sov, aes(x = indice_periode, y = part_appui)) +
  geom_ribbon(aes(ymin = ic_bas, ymax = ic_haut), fill = "#9fb6ce", alpha = 0.35, na.rm = TRUE) +
  geom_line(linewidth = 1, color = "#12355b", na.rm = TRUE) +
  geom_point(size = 2.3, color = "#b5651d", na.rm = TRUE) +
  geom_smooth(
    method = "loess",
    se = TRUE,
    span = 0.9,
    color = "#12355b",
    fill = "#c9d6e4",
    alpha = 0.25,
    linetype = "dashed",
    linewidth = 0.8,
    na.rm = TRUE
  ) +
  scale_y_continuous(labels = function(x) paste0(round(100 * x, 0), "%"), limits = c(0, ymax_sov)) +
  scale_x_continuous(breaks = seq_along(periodes), labels = periodes) +
  labs(
    title = "Évolution de l'appui à la souveraineté dans les études QES",
    x = "Période d'étude",
    y = "Part des répondants"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(size = 9))
```

## Notes

- La tendance utilise la question directe sur la souveraineté de chaque étude.
- Le jeu `qes_crop_2007_2010` est ventilé en 2007, 2008, 2009 et 2010 à partir de sa variable de date de collecte.
- Les intervalles de confiance sont des IC95 binomiaux (approximation normale).
- La colonne `N avec item souveraineté` indique la couverture disponible selon la période.
