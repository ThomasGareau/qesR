---
title: "Use case example: Evolution of Sovereignty Attitudes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use case example: Evolution of Sovereignty Attitudes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library(qesR)
library(dplyr)
library(ggplot2)
library(knitr)
```

This page uses the merged file to estimate sovereignty support over time.

<details>
<summary>Show code used in this page</summary>

```r
library(dplyr)
library(ggplot2)
library(knitr)

master_paths <- c("qes_master.csv", "../qes_master.csv")
master <- read.csv(master_paths[file.exists(master_paths)][1], stringsAsFactors = FALSE)

master <- master %>%
  mutate(
    qes_year_chr = trimws(as.character(qes_year)),
    qes_year_num = as.integer(substr(qes_year_chr, 1, 4))
  )

is_range <- grepl("^[0-9]{4}-[0-9]{4}$", master$qes_year_chr)
start_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\1", master$qes_year_chr)))
end_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\2", master$qes_year_chr)))

master$study_period <- ifelse(
  is_range,
  master$qes_year_chr,
  ifelse(!is.na(master$qes_year_num), as.character(master$qes_year_num), master$qes_year_chr)
)
master$period_order <- ifelse(
  is_range & is.finite(start_year) & is.finite(end_year),
  (start_year + end_year) / 2,
  master$qes_year_num
)

master$sovereignty_support <- suppressWarnings(as.numeric(master$sovereignty_support))
master$sovereignty_support[!(master$sovereignty_support %in% c(0, 1))] <- NA_real_

all_periods <- master %>%
  filter(!is.na(study_period), nzchar(study_period), !is.na(period_order)) %>%
  distinct(study_period, period_order)

sov <- master %>%
  filter(!is.na(study_period), nzchar(study_period), !is.na(period_order)) %>%
  group_by(study_period, period_order) %>%
  summarise(
    respondents = n(),
    n_with_measure = sum(!is.na(sovereignty_support)),
    support_share = ifelse(n_with_measure > 0, mean(sovereignty_support, na.rm = TRUE), NA_real_),
    se = ifelse(n_with_measure > 0, sqrt(pmax(support_share * (1 - support_share), 0) / n_with_measure), NA_real_),
    ci_low = ifelse(!is.na(se), pmax(0, support_share - 1.96 * se), NA_real_),
    ci_high = ifelse(!is.na(se), pmin(1, support_share + 1.96 * se), NA_real_),
    .groups = "drop"
  )

sov <- merge(all_periods, sov, by = c("study_period", "period_order"), all.x = TRUE, sort = TRUE)
sov <- sov %>% arrange(period_order, study_period)
sov$period_index <- seq_len(nrow(sov))

knitr::kable(sov)
```

</details>

```{r, include = FALSE}
master_paths <- c("qes_master.csv", "../qes_master.csv")
master_path <- master_paths[file.exists(master_paths)][1]
if (is.na(master_path) || !nzchar(master_path)) {
  stop("Local qes_master.csv not found. Build it first with scripts/build_qes_master.R", call. = FALSE)
}
master <- read.csv(master_path, stringsAsFactors = FALSE)

master <- master %>%
  mutate(
    qes_year_chr = trimws(as.character(qes_year)),
    qes_year_num = suppressWarnings(as.integer(substr(qes_year_chr, 1, 4)))
  )

is_range <- grepl("^[0-9]{4}-[0-9]{4}$", master$qes_year_chr)
start_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\1", master$qes_year_chr)))
end_year <- suppressWarnings(as.numeric(sub("^([0-9]{4})-([0-9]{4})$", "\\2", master$qes_year_chr)))

master$study_period <- ifelse(
  is_range,
  master$qes_year_chr,
  ifelse(!is.na(master$qes_year_num), as.character(master$qes_year_num), master$qes_year_chr)
)
master$period_order <- ifelse(
  is_range & is.finite(start_year) & is.finite(end_year),
  (start_year + end_year) / 2,
  master$qes_year_num
)

if (!("sovereignty_support" %in% names(master))) {
  master$sovereignty_support <- NA_real_
}
master <- master %>%
  mutate(sovereignty_final = suppressWarnings(as.numeric(sovereignty_support)))

master$sovereignty_final[!(master$sovereignty_final %in% c(0, 1))] <- NA_real_

all_periods <- master %>%
  filter(!is.na(study_period), nzchar(study_period), !is.na(period_order)) %>%
  distinct(study_period, period_order)

sov <- master %>%
  filter(!is.na(study_period), nzchar(study_period), !is.na(period_order)) %>%
  group_by(study_period, period_order) %>%
  summarise(
    respondents = n(),
    n_with_measure = sum(!is.na(sovereignty_final)),
    support_share = ifelse(n_with_measure > 0, mean(sovereignty_final, na.rm = TRUE), NA_real_),
    se = ifelse(
      n_with_measure > 0,
      sqrt(pmax(support_share * (1 - support_share), 0) / n_with_measure),
      NA_real_
    ),
    ci_low = ifelse(!is.na(se), pmax(0, support_share - 1.96 * se), NA_real_),
    ci_high = ifelse(!is.na(se), pmin(1, support_share + 1.96 * se), NA_real_),
    .groups = "drop"
  )

sov <- merge(all_periods, sov, by = c("study_period", "period_order"), all.x = TRUE, sort = TRUE)
sov <- sov %>% arrange(period_order, study_period)
periods <- sov$study_period
sov$period_index <- seq_len(nrow(sov))
```

The estimates below use the dedicated sovereignty question harmonized across study periods.

## Table 1: sovereignty support by study period

```{r}
knitr::kable(
  sov %>%
    mutate(
      sovereignty_support_pct = round(100 * support_share, 1),
      ci_low_pct = round(100 * ci_low, 1),
      ci_high_pct = round(100 * ci_high, 1)
    ) %>%
    transmute(
      `Study period` = study_period,
      `N respondents` = respondents,
      `N with sovereignty item` = n_with_measure,
      `Sovereignty support (%)` = sovereignty_support_pct,
      `95% CI (%)` = ifelse(is.na(ci_low_pct), NA_character_, sprintf("%.1f to %.1f", ci_low_pct, ci_high_pct))
    ),
  caption = "Sovereignty support by study period"
)
```

## Figure 1: sovereignty trend

```{r, fig.alt="Line chart of sovereignty support trend over study periods."}
plot_sov <- sov %>%
  filter(!is.na(support_share), !is.na(ci_low), !is.na(ci_high), !is.na(period_index))
ymax_sov <- suppressWarnings(max(plot_sov$ci_high, plot_sov$support_share, na.rm = TRUE))
ymax_sov <- if (is.finite(ymax_sov)) min(1, ymax_sov + 0.05) else 1

ggplot(plot_sov, aes(x = period_index, y = support_share)) +
  geom_ribbon(aes(ymin = ci_low, ymax = ci_high), fill = "#9fb6ce", alpha = 0.35, na.rm = TRUE) +
  geom_line(linewidth = 1, color = "#12355b", na.rm = TRUE) +
  geom_point(size = 2.3, color = "#b5651d", na.rm = TRUE) +
  geom_smooth(
    method = "loess",
    se = TRUE,
    span = 0.9,
    color = "#12355b",
    fill = "#c9d6e4",
    alpha = 0.25,
    linetype = "dashed",
    linewidth = 0.8,
    na.rm = TRUE
  ) +
  scale_y_continuous(labels = function(x) paste0(round(100 * x, 0), "%"), limits = c(0, ymax_sov)) +
  scale_x_continuous(breaks = seq_along(periods), labels = periods) +
  labs(
    title = "Sovereignty support across QES studies",
    x = "Study period",
    y = "Share of respondents"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(size = 9))
```

## Notes

- The sovereignty trend uses the dedicated sovereignty item from each study.
- The `qes_crop_2007_2010` study is split into 2007, 2008, 2009, and 2010 using its collection-wave date variable.
- Confidence intervals are binomial 95% intervals using normal approximation.
- `n_with_measure` in the table shows where coverage is thinner.
