---
title: "Exemple de cas d'usage : évolution du choix de vote"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exemple de cas d'usage : évolution du choix de vote}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library(qesR)
library(dplyr)
library(ggplot2)
library(knitr)
```

```{r}
master_paths <- c("qes_master.csv", "../qes_master.csv")
master_path <- master_paths[file.exists(master_paths)][1]
if (is.na(master_path) || !nzchar(master_path)) {
  stop("qes_master.csv introuvable localement. Lancez d'abord scripts/build_qes_master.R", call. = FALSE)
}
master <- read.csv(master_path, stringsAsFactors = FALSE)

master <- master %>%
  mutate(
    annee = suppressWarnings(as.integer(substr(as.character(qes_year), 1, 4))),
    vote_choice_brut = trimws(as.character(vote_choice)),
    choix_vote_parti = case_when(
      vote_choice_brut %in% c("CAQ", "ADQ") ~ "CAQ/ADQ",
      vote_choice_brut == "PLQ" ~ "PLQ",
      vote_choice_brut == "PQ" ~ "PQ",
      vote_choice_brut == "QS" ~ "QS",
      vote_choice_brut == "PCQ" ~ "PCQ",
      TRUE ~ NA_character_
    )
  )

partis_majeurs <- c("CAQ/ADQ", "PLQ", "PQ", "QS", "PCQ")
```

<details>
<summary>Afficher le code utilisé dans cette page</summary>

```r
library(qesR)
library(dplyr)
library(ggplot2)
library(knitr)

master_paths <- c("qes_master.csv", "../qes_master.csv")
master <- read.csv(master_paths[file.exists(master_paths)][1], stringsAsFactors = FALSE) %>%
  mutate(
    annee = as.integer(substr(as.character(qes_year), 1, 4)),
    vote_choice_brut = trimws(as.character(vote_choice)),
    choix_vote_parti = dplyr::case_when(
      vote_choice_brut %in% c("CAQ", "ADQ") ~ "CAQ/ADQ",
      vote_choice_brut == "PLQ" ~ "PLQ",
      vote_choice_brut == "PQ" ~ "PQ",
      vote_choice_brut == "QS" ~ "QS",
      vote_choice_brut == "PCQ" ~ "PCQ",
      TRUE ~ NA_character_
    )
  )

partis_majeurs <- c("CAQ/ADQ", "PLQ", "PQ", "QS", "PCQ")

vote_base <- master %>%
  filter(!is.na(annee), !is.na(choix_vote_parti), nzchar(choix_vote_parti))

vote_den <- vote_base %>%
  group_by(annee) %>%
  summarise(n_avec_choix_vote = n(), .groups = "drop")

vote_parti <- vote_base %>%
  group_by(annee, choix_vote_parti) %>%
  summarise(n_parti = n(), .groups = "drop")

grille <- expand.grid(
  annee = sort(unique(vote_den$annee)),
  choix_vote_parti = partis_majeurs,
  stringsAsFactors = FALSE
)

vote_parti <- merge(grille, vote_parti, by = c("annee", "choix_vote_parti"), all.x = TRUE, sort = TRUE)
vote_parti$n_parti[is.na(vote_parti$n_parti)] <- 0
vote_parti <- merge(vote_parti, vote_den, by = "annee", all.x = TRUE, sort = TRUE)

vote_parti <- vote_parti %>%
  mutate(
    part = ifelse(n_avec_choix_vote > 0, n_parti / n_avec_choix_vote, NA_real_),
    se = ifelse(n_avec_choix_vote > 0, sqrt(pmax(part * (1 - part), 0) / n_avec_choix_vote), NA_real_),
    ci_bas = ifelse(!is.na(se), pmax(0, part - 1.96 * se), NA_real_),
    ci_haut = ifelse(!is.na(se), pmin(1, part + 1.96 * se), NA_real_)
  )

table_vote <- vote_parti %>%
  group_by(annee) %>%
  summarise(
    n_avec_choix_vote = first(n_avec_choix_vote),
    caq_adq = 100 * part[choix_vote_parti == "CAQ/ADQ"],
    plq = 100 * part[choix_vote_parti == "PLQ"],
    pq = 100 * part[choix_vote_parti == "PQ"],
    qs = 100 * part[choix_vote_parti == "QS"],
    pcq = 100 * part[choix_vote_parti == "PCQ"],
    .groups = "drop"
  ) %>%
  arrange(annee)

  knitr::kable(
  table_vote %>%
    transmute(
      `Annee d'etude` = annee,
      `N avec item choix de vote` = n_avec_choix_vote,
      `CAQ/ADQ (%)` = round(caq_adq, 1),
      `PLQ (%)` = round(plq, 1),
      `PQ (%)` = round(pq, 1),
      `QS (%)` = round(qs, 1),
      `PCQ (%)` = round(pcq, 1)
    )
)

vote_parti$choix_vote_parti <- factor(vote_parti$choix_vote_parti, levels = partis_majeurs)

ggplot(vote_parti, aes(x = annee, y = part, color = choix_vote_parti, group = choix_vote_parti)) +
  geom_ribbon(aes(ymin = ci_bas, ymax = ci_haut, fill = choix_vote_parti), alpha = 0.15, linewidth = 0) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2.1) +
  geom_smooth(method = "loess", se = FALSE, span = 0.9, linewidth = 0.8, linetype = "dashed") +
  scale_y_continuous(labels = function(x) paste0(round(100 * x, 0), "%")) +
  scale_x_continuous(breaks = sort(unique(vote_parti$annee))) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(), axis.text.x = element_text(size = 9))
```

</details>

## Tableau 1 : parts de choix de vote par annee

```{r}
vote_base <- master %>%
  filter(!is.na(annee), !is.na(choix_vote_parti), nzchar(choix_vote_parti))

vote_den <- vote_base %>%
  group_by(annee) %>%
  summarise(n_avec_choix_vote = n(), .groups = "drop")

vote_parti <- vote_base %>%
  group_by(annee, choix_vote_parti) %>%
  summarise(n_parti = n(), .groups = "drop")

grille <- expand.grid(
  annee = sort(unique(vote_den$annee)),
  choix_vote_parti = partis_majeurs,
  stringsAsFactors = FALSE
)

vote_parti <- merge(grille, vote_parti, by = c("annee", "choix_vote_parti"), all.x = TRUE, sort = TRUE)
vote_parti$n_parti[is.na(vote_parti$n_parti)] <- 0
vote_parti <- merge(vote_parti, vote_den, by = "annee", all.x = TRUE, sort = TRUE)

vote_parti <- vote_parti %>%
  mutate(
    part = ifelse(n_avec_choix_vote > 0, n_parti / n_avec_choix_vote, NA_real_),
    se = ifelse(
      n_avec_choix_vote > 0,
      sqrt(pmax(part * (1 - part), 0) / n_avec_choix_vote),
      NA_real_
    ),
    ci_bas = ifelse(!is.na(se), pmax(0, part - 1.96 * se), NA_real_),
    ci_haut = ifelse(!is.na(se), pmin(1, part + 1.96 * se), NA_real_)
  )

table_vote <- vote_parti %>%
  group_by(annee) %>%
  summarise(
    n_avec_choix_vote = first(n_avec_choix_vote),
    caq_adq = 100 * part[choix_vote_parti == "CAQ/ADQ"],
    plq = 100 * part[choix_vote_parti == "PLQ"],
    pq = 100 * part[choix_vote_parti == "PQ"],
    qs = 100 * part[choix_vote_parti == "QS"],
    pcq = 100 * part[choix_vote_parti == "PCQ"],
    .groups = "drop"
  ) %>%
  arrange(annee)

knitr::kable(
  table_vote %>%
    transmute(
      `Annee d'etude` = annee,
      `N avec item choix de vote` = n_avec_choix_vote,
      `CAQ/ADQ (%)` = round(caq_adq, 1),
      `PLQ (%)` = round(plq, 1),
      `PQ (%)` = round(pq, 1),
      `QS (%)` = round(qs, 1),
      `PCQ (%)` = round(pcq, 1)
  ),
  digits = 1,
  caption = "Parts de choix de vote des principaux partis par annee"
)
```

## Figure 1 : tendance du choix de vote

```{r, fig.alt="Graphique des parts de choix de vote pour la CAQ/ADQ, le PLQ, le PQ, QS et le PCQ selon l'annee."}
vote_parti$choix_vote_parti <- factor(vote_parti$choix_vote_parti, levels = partis_majeurs)
ymax_vote <- suppressWarnings(max(vote_parti$ci_haut, vote_parti$part, na.rm = TRUE))
ymax_vote <- if (is.finite(ymax_vote)) min(1, ymax_vote + 0.05) else 1

ggplot(vote_parti, aes(x = annee, y = part, color = choix_vote_parti, group = choix_vote_parti)) +
  geom_ribbon(aes(ymin = ci_bas, ymax = ci_haut, fill = choix_vote_parti), alpha = 0.15, linewidth = 0) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2.1) +
  geom_smooth(
    method = "loess",
    se = FALSE,
    span = 0.9,
    linewidth = 0.8,
    linetype = "dashed"
  ) +
  scale_color_manual(
    values = c(
      "CAQ/ADQ" = "#12355b",
      "PLQ" = "#2c7fb8",
      "PQ" = "#b5651d",
      "QS" = "#7a3e2d",
      "PCQ" = "#ba181b"
    ),
    name = "Parti"
  ) +
  scale_fill_manual(
    values = c(
      "CAQ/ADQ" = "#12355b",
      "PLQ" = "#2c7fb8",
      "PQ" = "#b5651d",
      "QS" = "#7a3e2d",
      "PCQ" = "#ba181b"
    ),
    guide = "none"
  ) +
  scale_y_continuous(labels = function(x) paste0(round(100 * x, 0), "%"), limits = c(0, ymax_vote)) +
  scale_x_continuous(breaks = sort(unique(vote_parti$annee))) +
  labs(
    title = "Choix de vote des principaux partis dans le temps",
    x = "Année d'étude",
    y = "Part des répondants"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 9)
  )
```

## Notes

- Les parts utilisent les répondants avec une valeur non manquante de `vote_choice`.
- Les années 2009 et 2010 proviennent de `qes_crop_2007_2010` après ventilation par année de collecte.
- Les intervalles de confiance sont des IC95 binomiaux (approximation normale).
- La figure est limitée à la CAQ/ADQ, au PLQ, au PQ, à QS et au PCQ.
